终于又要开新的一章了，这次我们来聊聊内存相关但又相对独立的一块 -- 虚拟内存空间。

从我现在的角度去看，内核中的内存管理可以分成两个重要的部分：

  * 物理内存分配回收
  * 虚拟内存空间管理

其中第一部分在[自底而上话内存][1]一章中做了描述，第二部分将在这章展开。

其实这两部分并不是完全分割的，而是你中有我，我中有你。只是在一定层次上看，第一部分的内容已经相对完整可以自成一个体系了。

虽然在本章中将紧密得引用第一部分的内容，尤其是struct page，但是我们还是可以尽量将本章分成一下三个部分来描述。

  * 页表
  * vma
  * 反向映射

# 反向映射

反向映射是用来搜索对于某一个内存页，都有哪些进程在使用。其中分成了匿名页和文件页。

反向映射的架构也是经历了一番周折才定型为现在的样子。首先我们来说说[匿名反向映射的前世今生][2]

看了上文后，大家一定对反向映射有了概念性的认识。但是你一定想不到在学习反向映射的过程中有一个非常繁琐的内容 -- mapcount。

从概念上看这个值的含义是表示当前页映射到页表的个数，案例是比较好理解的。但是当这个数遇到了透明大页(THP)后就产生了各种纠缠不清的恩恩怨怨。在[THP和mapcount之间的恩恩怨怨][3]文章中，我将给大家尝试理清楚这中间的是是非非。

[1]: /mm/00-memory_a_bottom_up_view.md
[2]: /virtual_mm/01-anon_rmap_history.md
[3]: /virtual_mm/02-thp_mapcount.md
